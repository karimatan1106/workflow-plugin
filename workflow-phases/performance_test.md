# Performance Test フェーズ

## 目的

実装がパフォーマンス要件を満たしていることを確認する。

## 入力

- タスクディレクトリ: `{workflowDir}`
- 実装済みコード
- パフォーマンス要件（仕様書に記載）

## 実行手順

1. **パフォーマンス要件の確認**

   - 仕様書からパフォーマンス要件を抽出
   - 目標レスポンス時間を確認
   - 目標スループットを確認

2. **ベンチマークテストの実行**

   ```bash
   # 例: APIレスポンス時間の計測
   pnpm test:benchmark

   # 例: 負荷テスト
   pnpm test:load
   ```

3. **プロファイリング**

   - CPU使用率の計測
   - メモリ使用量の計測
   - ボトルネックの特定

4. **大量データでの動作確認**

   - 大量レコードでのクエリ性能
   - ページネーションの動作
   - メモリリークの確認

5. **並行処理時の動作確認**

   - 同時接続数の確認
   - レースコンディションの確認
   - デッドロックの確認

6. **結果の分析と最適化**
   - ボトルネックの特定
   - 最適化の実施
   - 再計測

## パフォーマンス目標

### APIレスポンス時間

| 操作          | 目標      |
| ------------- | --------- |
| 一覧取得      | < 200ms   |
| 詳細取得      | < 100ms   |
| 作成・更新    | < 300ms   |
| 複雑なクエリ  | < 500ms   |

### リソース使用量

| 項目          | 目標      |
| ------------- | --------- |
| メモリ使用量  | < 512MB   |
| CPU使用率     | < 70%     |
| 接続数        | > 100同時 |

### データ処理

| 操作              | 目標        |
| ----------------- | ----------- |
| 1000件の処理      | < 1秒       |
| 10000件の処理     | < 10秒      |
| バッチ処理        | < 5分       |

## チェックリスト

### レスポンス時間

- [ ] API レスポンス時間が許容範囲内
- [ ] ページ読み込み時間が許容範囲内
- [ ] データベースクエリが最適化されている

### リソース使用量

- [ ] メモリ使用量が適切
- [ ] CPU 使用率が許容範囲内
- [ ] メモリリークがない

### 大量データ

- [ ] 大量データでも正常動作する
- [ ] ページネーションが正しく動作する
- [ ] クエリが N+1 問題を起こしていない

### 並行処理

- [ ] 同時接続でも正常動作する
- [ ] レースコンディションがない
- [ ] デッドロックがない

### 既存機能への影響

- [ ] 既存機能のパフォーマンスが劣化していない
- [ ] 全体的なシステム負荷が許容範囲内

## 確認方法

### ベンチマークテスト

```typescript
// 例: レスポンス時間の計測
const start = performance.now();
const result = await api.getData();
const duration = performance.now() - start;
console.log(`Response time: ${duration}ms`);
```

### プロファイリングツール

```bash
# Node.js プロファイリング
node --prof app.js

# Chrome DevTools でメモリプロファイリング
# Performance タブで計測
```

### 負荷テスト

```bash
# 例: Apache Bench
ab -n 1000 -c 100 http://localhost:3000/api/data

# 例: Artillery
npx artillery run loadtest.yml
```

## log.md への記録

```markdown
### PERFORMANCE_TEST（パフォーマンステスト）

- テスト環境:
  - マシン: [スペック]
  - データ量: [件数]
- レスポンス時間:
  - 一覧取得: XXms (目標: 200ms)
  - 詳細取得: XXms (目標: 100ms)
- リソース使用量:
  - メモリ: XXX MB
  - CPU: XX%
- 大量データテスト:
  - 1000件: X秒
  - 10000件: X秒
- 並行処理テスト:
  - 同時接続数: XXX
  - 失敗率: X%
- 最適化した箇所:
  - [箇所1]: [内容]
```

## エラー対応

### レスポンス時間超過

1. プロファイリングでボトルネックを特定
2. クエリの最適化（インデックス追加、N+1解消）
3. キャッシュの導入
4. 非同期処理の活用

### メモリリーク

1. ヒープダンプを取得
2. リークしているオブジェクトを特定
3. 適切にリソースを解放
4. WeakMap/WeakSet の活用

### 並行処理の問題

1. ロックの見直し
2. トランザクションの最適化
3. コネクションプールの調整

## 禁止事項

- パフォーマンス目標未達で次に進む
- ボトルネックを放置する
- 負荷テストをスキップする
- メモリリークを放置する
- 既存機能のパフォーマンス劣化を放置する

## 完了条件

- [ ] パフォーマンス要件を満たしている
- [ ] レスポンス時間が許容範囲内
- [ ] メモリ使用量が適切
- [ ] CPU 使用率が許容範囲内
- [ ] 大量データでの動作確認済み
- [ ] 並行処理時の動作確認済み
- [ ] 既存機能のパフォーマンス劣化がない
- [ ] log.md に記録した
