# Refactoring フェーズ (TDD Refactor)

## subagent実行

このフェーズは**subagentとして実行**される。

---

## 目的

コード品質を改善する（TDD Refactor フェーズ）。

**重要**: テストが通る状態を維持しながらリファクタリング。

## 入力

- タスクディレクトリ: `{workflowDir}`
- 実装コード: 前フェーズで作成したコード
- テストコード: `*.test.ts`

## 実行手順

1. **リファクタリング対象の特定**
   - コードの重複
   - 複雑な条件分岐
   - 長いメソッド
   - マジックナンバー

2. **リファクタリング実施**
   - 小さな変更を繰り返す
   - 各変更後にテストを実行

3. **テスト実行（維持確認）**
   - 全テストが通ることを確認
   - カバレッジが維持されていることを確認

4. **コード品質確認**
   - Lintエラーがないこと
   - 型エラーがないこと

## リファクタリング観点

### コードの改善

- [ ] 重複コードの抽出・共通化
- [ ] 長いメソッドの分割
- [ ] 複雑な条件分岐の簡素化
- [ ] マジックナンバーの定数化
- [ ] 変数名・関数名の改善

### 設計の改善

- [ ] 責務の分離
- [ ] 依存性の注入
- [ ] インターフェースの抽出
- [ ] デザインパターンの適用

### 可読性の改善

- [ ] コメントの追加（必要な箇所のみ）
- [ ] 処理の順序整理
- [ ] 早期リターンの適用

## リファクタリングのルール

### やるべきこと

1. **小さな変更を繰り返す**
   - 一度に大きな変更をしない
   - 各変更後にテストを実行

2. **テストを維持**
   - テストが失敗したらすぐに戻す
   - 新しいテストは追加しない（テスト対象の変更なし）

3. **動作を変えない**
   - 外部から見た動作は同じ
   - パフォーマンス改善は含める

### やってはいけないこと

- 機能の追加・変更
- テストファイルの大幅な変更
- テストが失敗する状態で放置

## 出力ファイル

- リファクタリングされたソースコード

## log.md への記録

```markdown
### REFACTORING（リファクタリング - TDD Refactor）

- リファクタリング内容:
  - [改善1]: [対象ファイル:行番号]
  - [改善2]: [対象ファイル:行番号]
- テスト結果: 全 X 件パス（維持）
- コード品質:
  - Lint: OK
  - 型チェック: OK
```

## 禁止事項

- 機能の追加・変更
- テストの削除
- テストが失敗する状態での終了

## 完了条件

- [ ] コード重複を解消した
- [ ] 可読性を改善した
- [ ] **全テストがパスしている（維持）**
- [ ] Lintエラーがない
- [ ] 型エラーがない
- [ ] log.md に記録した
